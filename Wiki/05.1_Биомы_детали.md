# Биомы — общие правила генерации

Кодовые источники: `scripts/WorldBiomesGenerator.cs`, `scripts/WallSystem.cs`, `scripts/BiomePalette.cs`, `scripts/WorldResourcePlacer.cs`.

## Общие принципы
- Единая мировая сетка; биомы раскладываются по Poisson‑подобным центрам и Voronoi L1.
- Пол: базовая заливка по биому; редкие «вкрапления» расставляются детерминированным хэшем с оконными квотами и анти‑слипанием.
- Стены: топология строится отдельно (магистраль MST, холлы, локальные связки), затем стены = всё, что не Room.
- Оверлей стен: дополнительный верхний слой для визуальных акцентов (полосы/пульсация), правила зависят от биома.
- Ресурсы: спавнятся только на проходимых тайлах (Room), вероятность и тип зависят от биома.

Термины: координаты тайлов указываются как `(x,y)` в атласе; для стен дополнительно может быть `sourceId`.

## Пол (общая логика)
- Базовый тайл выбирается по биому; для вариативности используется когерентный выбор по крупной сетке + небольшой локальный джиттер.
- Редкие вкрапления:
  - Кандидаты выбираются детерминированным хэшем.
  - Применяются оконные квоты (обычно 4×4) для равномерности.
  - Анти‑слипание: запрет соседства (4‑ или 8‑соседей) в зависимости от биома.
- Конкретные тайлы, плотности и запреты см.: страницы отдельных биомов.

## Стены (общая логика)
- Выбор тайла стены централизован через `BiomePalette.GetWallTileForBiomeEx(biome, pos)`.
- После вырезания проходимых областей (магистраль/холлы/коридоры/комнаты) всё остальное помечается как `Wall` и заполняется тайлами стен.
- Верхний слой (overlay) используется для редких акцентов (полосы/пульсация) там, где это предусмотрено биомом.
- Подробные матрицы и overlay‑правила см.: страницы биомов.

## Топология (магистраль, холлы, коридоры)
- Магистраль: минимальное остовное дерево (MST) между центрами биомов; коридоры — органичные полилинии с fBm‑смещением и вариативной шириной; края дополнительно «разлохмачиваются».
- Холлы: для каждого биома вырезается зал; размеры и форма зависят от площади биома (для леса — вытянутый эллипс). Холл соединяется с магистралью локальным коридором.
- Комнаты: доборы площади проходимых участков органичными комнатами и связками.

## Прореживание внутренних стен (общая логика)
- Граница с воздухом: визуально убирается часть крайних тайлов для «дыхания» края.
- Второй ряд от границы: шахматное разрежение.
- В глубине массива стен: короткие «микрокластеры» удаления и редкие одиночные удаления по шаблону; параметры зависят от биома.

## Ресурсы (общая логика)
- Спавнятся только на `Room`, вдали от стен/краёв; вероятность и тип ресурса зависят от биома.
- Точки размещения детерминированы (через хэш/окна), чтобы сохранять повторяемость при одном сидe.
- Конкретные проценты и смещения типов — на страницах биомов.

## Детерминизм и стабильность
- Вариативность и редкие замены основаны на локальных хэш‑функциях (Hash2D), дающих устойчивую картину при фиксированном сидe мира.
- Оконные квоты предотвращают локальные перекосы плотностей.

## Ссылки на страницы биомов
- [[05.1.0_Grassland]]
- [[05.1.1_Forest]]
- [[05.1.2_Desert]]
- [[05.1.3_Ice]]
- [[05.1.4_Techno]]
- [[05.1.5_Anomal]]
- [[05.1.6_Lava_Springs]]


